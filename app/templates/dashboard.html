{% extends "_base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Master Platform Filter -->
    <div class="d-flex justify-content-center my-4">
        <div class="btn-group shadow" role="group">
            {% for platform in platforms %}
            <a href="?platform={{ platform }}" class="btn btn-outline-secondary {% if platform == selected_platform %}active{% endif %} p-3">
                <img src="{{ url_for('static', filename='platform_logos/' + platform.replace('+','_').replace(' ','_') + '.png') }}" height="20" class="me-2" alt="{{ platform }}"/>
                {{ platform }}
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <!-- Left Panel: KPIs and Map -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header fw-bold">Platform KPIs</div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3"><h5>Total Users</h5><p class="display-6">{{ kpis.total_customers }}</p></div>
                        <div class="col-6 mb-3"><h5>Churn Rate</h5><p class="display-6 text-danger">{{ kpis.churn_rate }}</p></div>
                        <div class="col-6"><h5>Avg. Tenure</h5><p class="display-6">{{ kpis.avg_tenure }}</p></div>
                        <div class="col-6"><h5>Avg. Watch Time</h5><p class="display-6">{{ kpis.avg_watch_hours }}</p></div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    {{ map_plot | safe }}
                </div>
            </div>
        </div>

        <!-- Right Panel: Tabs for Deep Dives -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link active" id="content-tab" data-bs-toggle="tab" data-bs-target="#content" type="button" role="tab">Content & Revenue</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="predictive-tab" data-bs-toggle="tab" data-bs-target="#predictive" type="button" role="tab">Predictive Hub</button></li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="myTabContent">
                        <!-- Content & Revenue Tab -->
                        <div class="tab-pane fade show active" id="content" role="tabpanel">
                            <div class="row">
                                <div class="col-12">{{ content_plot | safe }}</div>
                                <hr class="my-4">
                                <div class="col-12">{{ revenue_plot | safe }}</div>
                            </div>
                        </div>
                        <!-- Predictive Hub Tab -->
                        <div class="tab-pane fade" id="predictive" role="tabpanel">
                            <h4 class="mb-3">Live Churn Prediction for a <span class="text-primary">{{ selected_platform }}</span> User</h4>
                            <form id="prediction-form">
                                <!-- Dynamically filled form -->
                                <div class="row">
                                    <div class="col-md-3 mb-2"><label>Platform</label><input type="text" name="platform" class="form-control" value="{{ sample_user.platform }}" readonly></div>
                                    <div class="col-md-3 mb-2"><label>State</label><select name="state" class="form-select">{% for s in form_options.state %}<option value="{{ s }}" {% if s == sample_user.state %}selected{% endif %}>{{ s }}</option>{% endfor %}</select></div>
                                    <div class="col-md-3 mb-2"><label>Age</label><input type="number" name="age" class="form-control" value="{{ sample_user.age }}"></div>
                                    <div class="col-md-3 mb-2"><label>Gender</label><select name="gender" class="form-select">{% for g in form_options.gender %}<option value="{{ g }}" {% if g == sample_user.gender %}selected{% endif %}>{{ g }}</option>{% endfor %}</select></div>
                                    <div class="col-md-3 mb-2"><label>Plan Type</label><select name="plan_type" class="form-select">{% for p in form_options.plan_type %}<option value="{{ p }}" {% if p == sample_user.plan_type %}selected{% endif %}>{{ p }}</option>{% endfor %}</select></div>
                                    <div class="col-md-3 mb-2"><label>Monthly Price</label><input type="number" name="monthly_price" class="form-control" value="{{ sample_user.monthly_price }}"></div>
                                    <div class="col-md-3 mb-2"><label>Tenure (Months)</label><input type="number" name="tenure_months" class="form-control" value="{{ sample_user.tenure_months }}"></div>
                                    <div class="col-md-3 mb-2"><label>Watch Hours/Mo</label><input type="number" name="monthly_watch_hours" class="form-control" value="{{ sample_user.monthly_watch_hours | round(1) }}"></div>
                                    <div class="col-md-3 mb-2"><label>Days Since Login</label><input type="number" name="days_since_last_login" class="form-control" value="{{ sample_user.days_since_last_login }}"></div>
                                    <div class="col-md-3 mb-2"><label>Support Tickets</label><input type="number" name="support_tickets" class="form-control" value="{{ sample_user.support_tickets }}"></div>
                                    <div class="col-md-3 mb-2"><label>Main Genre</label><select name="main_genre_focus" class="form-select">{% for g in form_options.main_genre_focus %}<option value="{{ g }}" {% if g == sample_user.main_genre_focus %}selected{% endif %}>{{ g }}</option>{% endfor %}</select></div>
                                    <div class="col-md-3 mb-2"><label># Genres Watched</label><input type="number" name="watched_genres_count" class="form-control" value="{{ sample_user.watched_genres_count }}"></div>
                                </div>
                                <button type="submit" class="btn btn-primary mt-3">Analyze Churn Risk</button>
                            </form>
                            <div id="prediction-result" class="mt-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.getElementById('prediction-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    const resultDiv = document.getElementById('prediction-result');
    resultDiv.innerHTML = `<div class="d-flex align-items-center"><strong role="status">Analyzing...</strong><div class="spinner-border ms-auto" aria-hidden="true"></div></div>`;

    const response = await fetch('/api/predict', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    const result = await response.json();

    let alertClass = result.prediction === 1 ? 'alert-danger' : 'alert-success';
    let predictionText = result.prediction === 1 ? 'High Risk of Churn' : 'Low Risk of Churn';

    resultDiv.innerHTML = `
        <div class="alert ${alertClass}">
            <h4 class="alert-heading">${predictionText}</h4>
            <p>The model predicts a <strong>${(result.probability * 100).toFixed(2)}%</strong> probability of churn for this user.</p>
            <hr>
            <p class="mb-0 fw-bold">Key Factors Driving This Prediction:</p>
            <div class="shap-container">${result.shap_html}</div>
        </div>
    `;
});
</script>
{% endblock %}